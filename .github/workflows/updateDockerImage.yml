name: Deploy Backend and MongoDB to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: gamebox-rg
  CONTAINER_APP_ENV: gamebox-env
  BACKEND_APP_NAME: gamebox-backend
  MONGODB_APP_NAME: gamebox-mongodb
  LOCATION: eastus
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/gamebox-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group (if not exists)
        run: |
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} || true

      - name: Create Container Apps Environment (if not exists)
        run: |
          az containerapp env create \
            --name ${{ env.CONTAINER_APP_ENV }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} || true

      - name: Deploy MongoDB Container App
        run: |
          if az containerapp show --name ${{ env.MONGODB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &> /dev/null; then
            echo "Updating existing MongoDB container app..."
            az containerapp update \
              --name ${{ env.MONGODB_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image mongo:6
          else
            echo "Creating new MongoDB container app..."
            az containerapp create \
              --name ${{ env.MONGODB_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_APP_ENV }} \
              --image mongo:6 \
              --target-port 27017 \
              --ingress internal \
              --min-replicas 1 \
              --max-replicas 1 \
              --cpu 0.5 \
              --memory 1.0Gi \
              --secrets \
                mongo-root-username=admin \
                mongo-root-password=admin123 \
              --env-vars \
                MONGO_INITDB_ROOT_USERNAME=secretref:mongo-root-username \
                MONGO_INITDB_ROOT_PASSWORD=secretref:mongo-root-password
          fi

      - name: Get MongoDB Internal URL
        id: mongo-url
        run: |
          MONGO_FQDN=$(az containerapp show \
            --name ${{ env.MONGODB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "MONGO_FQDN=$MONGO_FQDN" >> $GITHUB_OUTPUT

      - name: Deploy Backend Container App
        run: |
          if az containerapp show --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} &> /dev/null; then
            echo "Updating existing backend container app..."
            az containerapp update \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.DOCKER_IMAGE }}:latest
          else
            echo "Creating new backend container app..."
            az containerapp create \
              --name ${{ env.BACKEND_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_APP_ENV }} \
              --image ${{ env.DOCKER_IMAGE }}:latest \
              --target-port 3000 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 3 \
              --cpu 0.5 \
              --memory 1.0Gi \
              --secrets \
                mongo-uri="mongodb://admin:admin123@${{ steps.mongo-url.outputs.MONGO_FQDN }}:27017" \
              --env-vars \
                MONGO_URI=secretref:mongo-uri \
                NODE_ENV=production \
                PORT=3000
          fi

      - name: Get Backend URL
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "ðŸš€ Backend deployed at: https://$BACKEND_URL"
